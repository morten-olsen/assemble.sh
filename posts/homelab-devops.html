<!DOCTYPE html><html><head><style data-styled="" data-styled-version="5.3.0">body{margin:0;padding:0;font-family:'Merriweather',serif;line-height:1.8em;-webkit-letter-spacing:0.5px;-moz-letter-spacing:0.5px;-ms-letter-spacing:0.5px;letter-spacing:0.5px;}/*!sc*/
a{-webkit-text-decoration:none;text-decoration:none;font-weight:700;color:red;}/*!sc*/
data-styled.g1[id="sc-global-bSTLhA1"]{content:"sc-global-bSTLhA1,"}/*!sc*/
.lmLbLR{width:100%;max-width:900px;margin:auto;}/*!sc*/
data-styled.g2[id="Layout__Content-sc-uqo7bl-0"]{content:"lmLbLR,"}/*!sc*/
</style><link rel="preconnect" href="https://fonts.googleapis.com"/><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin="anonymous"/><script type="text/javascript">
  var _paq = window._paq = window._paq || [];
  /* tracker methods like "setCustomDimension" should be called before "trackPageView" */
  _paq.push(['trackPageView']);
  _paq.push(['enableLinkTracking']);
  (function() {
    var u="//matomo.mortenolsen.pro/";
    _paq.push(['setTrackerUrl', u+'matomo.php']);
    _paq.push(['setSiteId', '1']);
    var d=document, g=d.createElement('script'), s=d.getElementsByTagName('script')[0];
    g.type='text/javascript'; g.async=true; g.src=u+'matomo.js'; s.parentNode.insertBefore(g,s);
  })();
</script><meta name="viewport" content="width=device-width"/><meta charSet="utf-8"/><title>Homelabing, the DevOps way</title><meta name="next-head-count" content="3"/><noscript data-n-css=""></noscript><script defer="" nomodule="" src="/_next/static/chunks/polyfills-a54b4f32bdc1ef890ddd.js"></script><script src="/_next/static/chunks/webpack-61095c13c5984b221292.js" defer=""></script><script src="/_next/static/chunks/framework-92300432a1172ef1338b.js" defer=""></script><script src="/_next/static/chunks/main-a3a79aff3ff232b41814.js" defer=""></script><script src="/_next/static/chunks/pages/_app-2f06802712cfe7ee1e06.js" defer=""></script><script src="/_next/static/chunks/181-758d9e3d1eb98d9559dc.js" defer=""></script><script src="/_next/static/chunks/pages/posts/%5Bid%5D-115f5a876679645f75b4.js" defer=""></script><script src="/_next/static/xwecyld1ULqwugOVz650u/_buildManifest.js" defer=""></script><script src="/_next/static/xwecyld1ULqwugOVz650u/_ssgManifest.js" defer=""></script></head><body><div id="__next"><div class="Layout__Content-sc-uqo7bl-0 lmLbLR"><a href="/">Home</a><article><h1>Homelabing, the DevOps way</h1><div style="height:500px;position:relative"></div><p>So I have a home lab, and through its existance it have been managed in pretty much every way imaginable. I have done virtualization with ESXi, XCP-NG, Proxmox, I have run dedicated docker hosts, i have run Docker Swarm and Kubernetes as HA setups with hyper convergence using Gluster on CephFS. I have used docker, docker-compose, kubectl, helm, ansible, rancher, portainer etc. for daily managment and setup tasks. So from the most bare metal setup to large (or as large as I could make it with the hardware I have) setups.</p><p>One thing that has been a common thread between all these setups: Managing my homelab was a pain. Especially as I went for higher availability and an &quot;easier&quot;-to-use setup, the managerial pain increased. I felt like a System Administrator in my own home. Don&#x27;t get me wrong, I have respect for the profession and I don&#x27;t mind the odd SysAdm task now and again, but I prefer to experiment with the actual services instead of the underlaying metal.</p><p>This is why I have decided to change tactics, and this post tries to explain this new approach and how you could use it in your own homelab setup, if you as me are tired of speending more time managing than developing og spinning up new interesting services.</p><h2>No more HA</h2><p>Okay, this may be a weird path to go down, and this is most likely only a temorary path for me, but to get up and running I have decided that this time around I am not going to be focusing on high availability, but instead rely on an easy to setup and replicate setup with strong backup for restoring everything in case of a catastrofic failure. Therefor I am going to go with a single Docker node and just use host mounts for data storage. Later I will try to expand upon this using something like docker swarm or kubernetes along with hyper convergence, but atleast for now I want a simpler setup</p><h2>Queue the DevOps approach</h2><p>As said, I am not a SysAdm, I am a developer, and therefor the DevOps approach is more near and dear to my heart, and the one I will be using for this new setup.</p><p>I have been running Gitea to host some of my projects locally for a few years, and it is also what I am going to be using as configuration on project storage for this new setup. Additionally I need a CI/CD pipeline to build and deploy the projects that I host in my Gitea instance. For this perpose I will be using Drone CI with a Docker based runner.</p><p>So that is basically it, nice and simple right? So the flow works like this:</p><ul><li>Create a repo in Gitea</li><li>Enable builds on Drone CI for the new repo</li><li>Push the project along with a <code>.drone.yml</code> workflow file which will build and deploy the project</li></ul><h2>Setting up the system</h2><p>Okay so let us go through the initial setup. Not everythin can be automated, so it will require a few steps</p><p>First clone or download the project repository from TODO</p><p>Then we need to add in som environment variables. Create a <code>.env</code> file in the project with the follwing content (replace any values with your own)</p><pre><code>EXTERNAL_DOMAIN=external.loopback.services
INTERNAL_DOMAIN=internal.loopback.services
DATA_LOCATION=./data
CLOUDFLARE_TOKEN=some-token-here
CLOUDFLARE_EMAIL=you@email.here
</code></pre><p>Okay we are ready to setup the first two components, the Gitea git server and the traefik load balancer for our web traffic</p><pre><code>docker network create loadbalancer
docker-compose -p traefik -f docker-compose-0.yml
docker-compose -p gitea -f docker-compose-1.yml
</code></pre><p>Next we need to setup Drone with Gitea as the provider. The official documentation can be found <a href="https://docs.drone.io/server/provider/gitea/">here</a></p><p>Navigate to <code>https://gitea.external.loopback.services/user/settings/applications</code></p><p>And create a new application with any name you choose and the login url as <code>https://drone.external.loopback.services</code></p><p>This will give you a client id and a secret which we will use in a second</p><p>Next we need a shared key for drone and its workers. To create this we use the method propsed by the official documentation
<code>openssl rand -hex 16</code> which will give us a random 16 charator secret</p><p>We add these new information into our <code>.env</code> file below our existing values</p><pre><code>GITEA_CLIENT_ID=92491bfe-26ae-464e-8d75-7b7632ecce05
GITEA_CLIENT_SECRET=bx5vThgdfYRNqBV8rDGySyrZxeAuYaMXakXWm0IX6mM=
DRONE_RPC_SECRET=7dde7b625f9dc30cd3a8fb8f1a614dcc
DRONE_ADMIN=the-gitea-admin-user-name

</code></pre><p>Ready to rock!</p><pre><code>docker-compose -p drone -f docker-compose-2.yml
</code></pre><p>Now go to <code>https://drone.external.loopback.services</code> and complete the setup</p><p>Congratulation, setup is done! No more SysAdm, just DevOps from here</p></article></div></div><script id="__NEXT_DATA__" type="application/json">{"props":{"pageProps":{"postData":{"id":"homelab-devops","source":{"compiledSource":"var h=Object.defineProperty,c=Object.defineProperties;var m=Object.getOwnPropertyDescriptors;var i=Object.getOwnPropertySymbols;var r=Object.prototype.hasOwnProperty,s=Object.prototype.propertyIsEnumerable;var p=(e,a,t)=\u003ea in e?h(e,a,{enumerable:!0,configurable:!0,writable:!0,value:t}):e[a]=t,n=(e,a)=\u003e{for(var t in a||(a={}))r.call(a,t)\u0026\u0026p(e,t,a[t]);if(i)for(var t of i(a))s.call(a,t)\u0026\u0026p(e,t,a[t]);return e},d=(e,a)=\u003ec(e,m(a));var l=(e,a)=\u003e{var t={};for(var o in e)r.call(e,o)\u0026\u0026a.indexOf(o)\u003c0\u0026\u0026(t[o]=e[o]);if(e!=null\u0026\u0026i)for(var o of i(e))a.indexOf(o)\u003c0\u0026\u0026s.call(e,o)\u0026\u0026(t[o]=e[o]);return t};const layoutProps={},MDXLayout=\"wrapper\";function MDXContent(t){var o=t,{components:e}=o,a=l(o,[\"components\"]);return mdx(MDXLayout,d(n(n({},layoutProps),a),{components:e,mdxType:\"MDXLayout\"}),mdx(\"p\",null,\"So I have a home lab, and through its existance it have been managed in pretty much every way imaginable. I have done virtualization with ESXi, XCP-NG, Proxmox, I have run dedicated docker hosts, i have run Docker Swarm and Kubernetes as HA setups with hyper convergence using Gluster on CephFS. I have used docker, docker-compose, kubectl, helm, ansible, rancher, portainer etc. for daily managment and setup tasks. So from the most bare metal setup to large (or as large as I could make it with the hardware I have) setups.\"),mdx(\"p\",null,`One thing that has been a common thread between all these setups: Managing my homelab was a pain. Especially as I went for higher availability and an \"easier\"-to-use setup, the managerial pain increased. I felt like a System Administrator in my own home. Don't get me wrong, I have respect for the profession and I don't mind the odd SysAdm task now and again, but I prefer to experiment with the actual services instead of the underlaying metal.`),mdx(\"p\",null,\"This is why I have decided to change tactics, and this post tries to explain this new approach and how you could use it in your own homelab setup, if you as me are tired of speending more time managing than developing og spinning up new interesting services.\"),mdx(\"h2\",null,\"No more HA\"),mdx(\"p\",null,\"Okay, this may be a weird path to go down, and this is most likely only a temorary path for me, but to get up and running I have decided that this time around I am not going to be focusing on high availability, but instead rely on an easy to setup and replicate setup with strong backup for restoring everything in case of a catastrofic failure. Therefor I am going to go with a single Docker node and just use host mounts for data storage. Later I will try to expand upon this using something like docker swarm or kubernetes along with hyper convergence, but atleast for now I want a simpler setup\"),mdx(\"h2\",null,\"Queue the DevOps approach\"),mdx(\"p\",null,\"As said, I am not a SysAdm, I am a developer, and therefor the DevOps approach is more near and dear to my heart, and the one I will be using for this new setup.\"),mdx(\"p\",null,\"I have been running Gitea to host some of my projects locally for a few years, and it is also what I am going to be using as configuration on project storage for this new setup. Additionally I need a CI/CD pipeline to build and deploy the projects that I host in my Gitea instance. For this perpose I will be using Drone CI with a Docker based runner.\"),mdx(\"p\",null,\"So that is basically it, nice and simple right? So the flow works like this:\"),mdx(\"ul\",null,mdx(\"li\",{parentName:\"ul\"},\"Create a repo in Gitea\"),mdx(\"li\",{parentName:\"ul\"},\"Enable builds on Drone CI for the new repo\"),mdx(\"li\",{parentName:\"ul\"},\"Push the project along with a \",mdx(\"inlineCode\",{parentName:\"li\"},\".drone.yml\"),\" workflow file which will build and deploy the project\")),mdx(\"h2\",null,\"Setting up the system\"),mdx(\"p\",null,\"Okay so let us go through the initial setup. Not everythin can be automated, so it will require a few steps\"),mdx(\"p\",null,\"First clone or download the project repository from TODO\"),mdx(\"p\",null,\"Then we need to add in som environment variables. Create a \",mdx(\"inlineCode\",{parentName:\"p\"},\".env\"),\" file in the project with the follwing content (replace any values with your own)\"),mdx(\"pre\",null,mdx(\"code\",n({parentName:\"pre\"},{}),`EXTERNAL_DOMAIN=external.loopback.services\nINTERNAL_DOMAIN=internal.loopback.services\nDATA_LOCATION=./data\nCLOUDFLARE_TOKEN=some-token-here\nCLOUDFLARE_EMAIL=you@email.here\n`)),mdx(\"p\",null,\"Okay we are ready to setup the first two components, the Gitea git server and the traefik load balancer for our web traffic\"),mdx(\"pre\",null,mdx(\"code\",n({parentName:\"pre\"},{}),`docker network create loadbalancer\ndocker-compose -p traefik -f docker-compose-0.yml\ndocker-compose -p gitea -f docker-compose-1.yml\n`)),mdx(\"p\",null,\"Next we need to setup Drone with Gitea as the provider. The official documentation can be found \",mdx(\"a\",n({parentName:\"p\"},{href:\"https://docs.drone.io/server/provider/gitea/\"}),\"here\")),mdx(\"p\",null,\"Navigate to \",mdx(\"inlineCode\",{parentName:\"p\"},\"https://gitea.external.loopback.services/user/settings/applications\")),mdx(\"p\",null,\"And create a new application with any name you choose and the login url as \",mdx(\"inlineCode\",{parentName:\"p\"},\"https://drone.external.loopback.services\")),mdx(\"p\",null,\"This will give you a client id and a secret which we will use in a second\"),mdx(\"p\",null,`Next we need a shared key for drone and its workers. To create this we use the method propsed by the official documentation\n`,mdx(\"inlineCode\",{parentName:\"p\"},\"openssl rand -hex 16\"),\" which will give us a random 16 charator secret\"),mdx(\"p\",null,\"We add these new information into our \",mdx(\"inlineCode\",{parentName:\"p\"},\".env\"),\" file below our existing values\"),mdx(\"pre\",null,mdx(\"code\",n({parentName:\"pre\"},{}),`GITEA_CLIENT_ID=92491bfe-26ae-464e-8d75-7b7632ecce05\nGITEA_CLIENT_SECRET=bx5vThgdfYRNqBV8rDGySyrZxeAuYaMXakXWm0IX6mM=\nDRONE_RPC_SECRET=7dde7b625f9dc30cd3a8fb8f1a614dcc\nDRONE_ADMIN=the-gitea-admin-user-name\n\n`)),mdx(\"p\",null,\"Ready to rock!\"),mdx(\"pre\",null,mdx(\"code\",n({parentName:\"pre\"},{}),`docker-compose -p drone -f docker-compose-2.yml\n`)),mdx(\"p\",null,\"Now go to \",mdx(\"inlineCode\",{parentName:\"p\"},\"https://drone.external.loopback.services\"),\" and complete the setup\"),mdx(\"p\",null,\"Congratulation, setup is done! No more SysAdm, just DevOps from here\"))}MDXContent.isMDXComponent=!0;\n","scope":{}},"title":"Homelabing, the DevOps way","date":"2021-07-25"}},"__N_SSG":true},"page":"/posts/[id]","query":{"id":"homelab-devops"},"buildId":"xwecyld1ULqwugOVz650u","isFallback":false,"gsp":true,"scriptLoader":[]}</script></body></html>